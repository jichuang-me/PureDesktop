<Window x:Class="PureDesktop.Views.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="clr-namespace:PureDesktop.Views"
        xmlns:vm="clr-namespace:PureDesktop.ViewModels"
        Title="PureDesktop"
        WindowStyle="None"
        AllowsTransparency="True"
        Background="Transparent"
        ShowInTaskbar="False"
        Topmost="False"
        ResizeMode="NoResize"
        Loaded="OnLoaded">

    <Window.Resources>
        <Style TargetType="local:FenceControl">
            <Setter Property="Margin" Value="0" />
        </Style>
    </Window.Resources>

    <!-- Full-screen transparent canvas, fences float on the real desktop -->
    <Canvas x:Name="DesktopCanvas"
            Background="Transparent"
            ClipToBounds="False"
            MouseMove="OnGlobalMouseMove">

        <Canvas.ContextMenu>
            <ContextMenu>
                <MenuItem Header="{DynamicResource Tray_GroupFences}">
                    <MenuItem Header="{DynamicResource Tray_AutoOrganize}" Click="OnAutoOrganizeClick" FontWeight="Bold" />
                    <MenuItem Header="{DynamicResource Fence_New}" Click="OnNewFenceClick" />
                    <MenuItem Header="{DynamicResource Tray_AddMappedFence}" Click="OnAddMappedFenceClick" />
                    <MenuItem Header="{DynamicResource Menu_Refresh}" Click="OnRefreshClick" />
                </MenuItem>
                
                <MenuItem Header="{DynamicResource Tray_GroupAppearance}" StaysOpenOnClick="True">
                    <MenuItem Header="{DynamicResource Menu_ToggleFences}" Click="OnToggleFencesClick" />
                    <MenuItem Header="{DynamicResource Tray_Opacity}" x:Name="OpacityMenuMain" StaysOpenOnClick="True">
                        <StackPanel Orientation="Vertical" Margin="8,4" MouseMove="OnOpacityMouseMove" Background="Transparent" Cursor="Hand">
                            <TextBlock x:Name="OpacityValueText" Text="100%" Foreground="{DynamicResource TextSecondary}" FontSize="11" HorizontalAlignment="Right" Margin="0,0,0,4"/>
                            <Grid Width="150" Height="12">
                                <Border CornerRadius="6" ClipToBounds="True">
                                    <ProgressBar Value="{Binding ElementName=GlobalOpacitySlider, Path=Value}" Minimum="0.1" Maximum="1.0" 
                                                 Background="#22FFFFFF" Foreground="{DynamicResource AccentBrush}" 
                                                 BorderThickness="0" IsHitTestVisible="False"/>
                                </Border>
                                <Slider x:Name="GlobalOpacitySlider" Minimum="0.1" Maximum="1.0" Value="1.0" 
                                        TickFrequency="0.01" IsSnapToTickEnabled="True" 
                                        Opacity="0" IsHitTestVisible="False"
                                        ValueChanged="OnGlobalOpacitySliderChanged"
                                        PreviewMouseLeftButtonUp="OnGlobalOpacitySliderMouseUp"/>
                            </Grid>
                        </StackPanel>
                    </MenuItem>
                    <MenuItem Header="{DynamicResource Tray_Theme}" x:Name="ThemeMenuMain" StaysOpenOnClick="True" />
                    <MenuItem Header="{DynamicResource Tray_AccentColor}" x:Name="AccentMenuMain" StaysOpenOnClick="True">
                        <StackPanel Orientation="Vertical" Margin="8,4" 
                                    MouseLeave="OnPaletteMouseLeave" 
                                    Background="Transparent">
                            <TextBlock Text="{DynamicResource Tray_AccentColor}" Foreground="{DynamicResource TextSecondary}" FontSize="11" HorizontalAlignment="Right" Margin="0,0,0,4"/>
                            <UniformGrid Columns="6" Width="150" Height="25">
                                <Border Background="#FF0078D4" Margin="2" CornerRadius="4" Cursor="Hand" MouseEnter="OnPaletteColorPreview" MouseLeftButtonUp="OnPaletteColorCommit" Tag="#FF0078D4"/>
                                <Border Background="#FF00B294" Margin="2" CornerRadius="4" Cursor="Hand" MouseEnter="OnPaletteColorPreview" MouseLeftButtonUp="OnPaletteColorCommit" Tag="#FF00B294"/>
                                <Border Background="#FFE81123" Margin="2" CornerRadius="4" Cursor="Hand" MouseEnter="OnPaletteColorPreview" MouseLeftButtonUp="OnPaletteColorCommit" Tag="#FFE81123"/>
                                <Border Background="#FF8764B8" Margin="2" CornerRadius="4" Cursor="Hand" MouseEnter="OnPaletteColorPreview" MouseLeftButtonUp="OnPaletteColorCommit" Tag="#FF8764B8"/>
                                <Border Background="#FFF7630C" Margin="2" CornerRadius="4" Cursor="Hand" MouseEnter="OnPaletteColorPreview" MouseLeftButtonUp="OnPaletteColorCommit" Tag="#FFF7630C"/>
                                <Border Background="#FF00B7C3" Margin="2" CornerRadius="4" Cursor="Hand" MouseEnter="OnPaletteColorPreview" MouseLeftButtonUp="OnPaletteColorCommit" Tag="#FF00B7C3"/>
                            </UniformGrid>
                        </StackPanel>
                    </MenuItem>
                </MenuItem>
                
                <MenuItem Header="{DynamicResource Tray_GroupSettings}" StaysOpenOnClick="True" x:Name="SettingsMenuMain">
                    <MenuItem Header="{DynamicResource Tray_Behavior}" x:Name="BehaviorMenuMain" StaysOpenOnClick="True" />
                    <MenuItem Header="{DynamicResource Tray_Exclusions}" Click="OnExclusionsClick" />
                    <MenuItem Header="{DynamicResource Tray_Language}" x:Name="LangMenuMain" StaysOpenOnClick="True" />
                    <MenuItem Header="{DynamicResource Tray_ShowTrayIcon}" x:Name="ShowTrayIconMenu" IsCheckable="True" StaysOpenOnClick="True" Click="OnToggleTrayIconClick" />
                </MenuItem>
                
                <Separator />
                
                <MenuItem Header="{DynamicResource Tray_Manual}" Click="OnManualClick" />
                <MenuItem Header="{DynamicResource Tray_About}" Click="OnAboutClick" />
                <MenuItem Header="{DynamicResource Menu_Restart}" Click="OnRestartClick" />
                <MenuItem Header="{DynamicResource Menu_Exit}" Click="OnExitClick" />
            </ContextMenu>
        </Canvas.ContextMenu>

        <!-- ─── Fences Container ─── -->
        <ItemsControl x:Name="FenceHost"
                      ItemsSource="{Binding Fences}"
                      Opacity="{Binding FenceOpacity}">
            <ItemsControl.ItemsPanel>
                <ItemsPanelTemplate>
                    <Canvas />
                </ItemsPanelTemplate>
            </ItemsControl.ItemsPanel>

            <ItemsControl.ItemContainerStyle>
                <Style TargetType="ContentPresenter">
                    <Setter Property="Canvas.Left" Value="{Binding X}" />
                    <Setter Property="Canvas.Top" Value="{Binding Y}" />
                </Style>
            </ItemsControl.ItemContainerStyle>

            <ItemsControl.ItemTemplate>
                <DataTemplate DataType="{x:Type vm:FenceViewModel}">
                    <local:FenceControl DataContext="{Binding}" />
                </DataTemplate>
            </ItemsControl.ItemTemplate>
        </ItemsControl>

        <!-- ─── Recycle Bin icon (replaces hidden desktop icon) ─── -->
        <Border x:Name="RecycleBinIcon"
                Canvas.Left="10" Canvas.Bottom="40"
                Width="72" Height="80"
                CornerRadius="5"
                Background="Transparent"
                Cursor="Hand"
                MouseLeftButtonDown="OnRecycleBinClick">
            <Border.ContextMenu>
                <ContextMenu>
                    <MenuItem Header="{DynamicResource Ctx_Open}" Click="OnRecycleBinOpen" FontWeight="SemiBold" />
                    <MenuItem Header="{DynamicResource Recycle_Empty}" Click="OnRecycleBinEmpty" />
                </ContextMenu>
            </Border.ContextMenu>
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                <Image x:Name="RecycleBinImage"
                       Width="40" Height="40"
                       Stretch="Uniform"
                       HorizontalAlignment="Center"
                       RenderOptions.BitmapScalingMode="HighQuality" />
                <TextBlock x:Name="RecycleBinLabel"
                           Text="回收站 (v1.1)"
                           Foreground="White"
                           FontSize="11"
                           TextAlignment="Center"
                           HorizontalAlignment="Center"
                           Margin="0,3,0,0">
                    <TextBlock.Effect>
                        <DropShadowEffect ShadowDepth="1" BlurRadius="3" Opacity="0.8" Color="Black" />
                    </TextBlock.Effect>
                </TextBlock>
            </StackPanel>
        </Border>
    </Canvas>
</Window>
